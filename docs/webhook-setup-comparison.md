# Webhook è®¾ç½®å¯¹æ¯”ï¼šæœ¬åœ° vs ç”Ÿäº§ç¯å¢ƒ

## ğŸ¯ å¿«é€Ÿå›ç­”

### é—®é¢˜ï¼šæˆ‘éœ€è¦åœ¨ Stripe åå°è®¾ç½® Webhook åœ°å€å—ï¼Ÿ

**ç­”æ¡ˆ**ï¼šå–å†³äºä½ çš„ç¯å¢ƒ

| ç¯å¢ƒ | éœ€è¦åœ¨ Stripe Dashboard è®¾ç½®ï¼Ÿ | ä½¿ç”¨æ–¹æ³• |
|------|------------------------------|---------|
| æœ¬åœ°å¼€å‘ (localhost) | âŒ **ä¸éœ€è¦** | ä½¿ç”¨ `stripe listen` å‘½ä»¤ |
| ç”Ÿäº§ç¯å¢ƒ (Vercel) | âœ… **éœ€è¦** | åœ¨ Stripe Dashboard é…ç½® |

---

## ğŸ“Š è¯¦ç»†å¯¹æ¯”

### æ–¹æ¡ˆ 1: æœ¬åœ°å¼€å‘ - ä½¿ç”¨ Stripe CLI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ¬åœ°å¼€å‘ç¯å¢ƒ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Stripe æœåŠ¡å™¨                ä½ çš„ç”µè„‘
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚          â”‚               â”‚                          â”‚
  â”‚  Stripe  â”‚               â”‚  stripe listen           â”‚
  â”‚  Events  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  (Stripe CLI)            â”‚
  â”‚          â”‚   Webhook     â”‚         â”‚                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Events      â”‚         â–¼                â”‚
                             â”‚  localhost:3000          â”‚
                             â”‚  /api/payment/webhook    â”‚
                             â”‚                          â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é…ç½®æ­¥éª¤:
1. å®‰è£… Stripe CLI: scoop install stripe
2. ç™»å½•: stripe login
3. å¯åŠ¨è½¬å‘: stripe listen --forward-to localhost:3000/api/payment/webhook
4. å¤åˆ¶ whsec_xxx åˆ° .env.local
5. é‡å¯å¼€å‘æœåŠ¡å™¨

ä¼˜ç‚¹:
âœ… æ— éœ€é…ç½® Stripe Dashboard
âœ… è‡ªåŠ¨æ¥æ”¶æ‰€æœ‰äº‹ä»¶
âœ… å®æ—¶æŸ¥çœ‹äº‹ä»¶æ—¥å¿—
âœ… é€‚åˆå¼€å‘å’Œè°ƒè¯•

ç¼ºç‚¹:
âŒ éœ€è¦ä¿æŒ stripe listen è¿è¡Œ
âŒ æ¯æ¬¡é‡å¯ä¼šç”Ÿæˆæ–°çš„ç­¾åå¯†é’¥
```

---

### æ–¹æ¡ˆ 2: ç”Ÿäº§ç¯å¢ƒ - Stripe Dashboard é…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”Ÿäº§ç¯å¢ƒ (Vercel)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Stripe æœåŠ¡å™¨                Vercel æœåŠ¡å™¨
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚          â”‚               â”‚                          â”‚
  â”‚  Stripe  â”‚               â”‚  https://visutry         â”‚
  â”‚  Events  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  .vercel.app             â”‚
  â”‚          â”‚   Webhook     â”‚  /api/payment/webhook    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Events      â”‚                          â”‚
       â–²                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ é…ç½®åœ¨ Stripe Dashboard
       â”‚
  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
  â”‚  Webhook  â”‚
  â”‚  Endpoint â”‚
  â”‚  Settings â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é…ç½®æ­¥éª¤:
1. è®¿é—®: https://dashboard.stripe.com/webhooks
2. ç‚¹å‡» "Add endpoint"
3. è¾“å…¥ URL: https://visutry.vercel.app/api/payment/webhook
4. é€‰æ‹©äº‹ä»¶ç±»å‹
5. ä¿å­˜å¹¶å¤åˆ¶ç­¾åå¯†é’¥ (whsec_xxx)
6. åœ¨ Vercel æ·»åŠ ç¯å¢ƒå˜é‡: STRIPE_WEBHOOK_SECRET
7. é‡æ–°éƒ¨ç½²

ä¼˜ç‚¹:
âœ… ç¨³å®šå¯é 
âœ… è‡ªåŠ¨å¤„ç†é‡è¯•
âœ… å¯æŸ¥çœ‹å†å²è®°å½•
âœ… é€‚åˆç”Ÿäº§ç¯å¢ƒ

ç¼ºç‚¹:
âŒ éœ€è¦å…¬ç½‘å¯è®¿é—®çš„ URL
âŒ éœ€è¦æ‰‹åŠ¨é…ç½®
```

---

## ğŸ”§ åœ¨å“ªé‡Œè®¾ç½® Webhook åœ°å€

### æœ¬åœ°å¼€å‘ï¼šä¸éœ€è¦è®¾ç½®

ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œï¼š

```bash
stripe listen --forward-to localhost:3000/api/payment/webhook
```

---

### ç”Ÿäº§ç¯å¢ƒï¼šåœ¨ Stripe Dashboard è®¾ç½®

#### æ­¥éª¤ 1: è®¿é—® Webhook è®¾ç½®é¡µé¢

**æµ‹è¯•æ¨¡å¼**:
```
https://dashboard.stripe.com/test/webhooks
```

**ç”Ÿäº§æ¨¡å¼**:
```
https://dashboard.stripe.com/webhooks
```

#### æ­¥éª¤ 2: æ·»åŠ ç«¯ç‚¹

1. ç‚¹å‡» **"+ Add endpoint"** æŒ‰é’®

2. å¡«å†™è¡¨å•ï¼š

   **Endpoint URL**:
   ```
   https://your-domain.vercel.app/api/payment/webhook
   ```
   
   ä¾‹å¦‚:
   ```
   https://visutry.vercel.app/api/payment/webhook
   ```

3. ç‚¹å‡» **"Select events"**

4. é€‰æ‹©ä»¥ä¸‹äº‹ä»¶ï¼š
   - âœ… checkout.session.completed
   - âœ… customer.subscription.created
   - âœ… customer.subscription.updated
   - âœ… customer.subscription.deleted
   - âœ… invoice.payment_succeeded
   - âœ… invoice.payment_failed

5. ç‚¹å‡» **"Add endpoint"** ä¿å­˜

#### æ­¥éª¤ 3: è·å–ç­¾åå¯†é’¥

ä¿å­˜åï¼Œåœ¨ç«¯ç‚¹è¯¦æƒ…é¡µé¢ï¼š

1. æ‰¾åˆ° **"Signing secret"** éƒ¨åˆ†
2. ç‚¹å‡» **"Reveal"** æ˜¾ç¤ºå¯†é’¥
3. å¤åˆ¶å¯†é’¥ï¼ˆæ ¼å¼: `whsec_xxxxxxxx...`ï¼‰

#### æ­¥éª¤ 4: é…ç½®åˆ° Vercel

1. è®¿é—® Vercel é¡¹ç›®è®¾ç½®
2. è¿›å…¥ **Environment Variables**
3. æ·»åŠ å˜é‡ï¼š
   - Name: `STRIPE_WEBHOOK_SECRET`
   - Value: `whsec_xxxxxxxx...`
   - Environment: Production
4. ä¿å­˜å¹¶é‡æ–°éƒ¨ç½²

---

## ğŸ¨ å¯è§†åŒ–ç•Œé¢ä½ç½®

### Stripe Dashboard - Webhook è®¾ç½®é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stripe Dashboard                                    [æµ‹è¯•] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  å¼€å‘è€… > Webhooks                                         â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  Webhooks                          [+ Add endpoint] â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ Endpoint URL                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ https://visutry.vercel.app/api/payment/webhook â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Events to send                                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â˜‘ checkout.session.completed                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â˜‘ customer.subscription.created                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â˜‘ customer.subscription.updated                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â˜‘ customer.subscription.deleted                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â˜‘ invoice.payment_succeeded                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ â˜‘ invoice.payment_failed                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Signing secret                                 â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ whsec_â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢  [Reveal] [Copy]   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

- [ ] å®‰è£… Stripe CLI
- [ ] è¿è¡Œ `stripe login`
- [ ] è¿è¡Œ `stripe listen --forward-to localhost:3000/api/payment/webhook`
- [ ] å¤åˆ¶ `whsec_xxx` åˆ° `.env.local`
- [ ] é‡å¯å¼€å‘æœåŠ¡å™¨ (`npm run dev`)
- [ ] æµ‹è¯•: `stripe trigger checkout.session.completed`
- [ ] éªŒè¯: `node scripts/check-payments.js`

### ç”Ÿäº§ç¯å¢ƒ

- [ ] é¡¹ç›®å·²éƒ¨ç½²åˆ° Vercel
- [ ] è·å–ç”Ÿäº§ç¯å¢ƒ URL (ä¾‹å¦‚: `https://visutry.vercel.app`)
- [ ] è®¿é—® Stripe Dashboard Webhooks é¡µé¢
- [ ] æ·»åŠ  Webhook ç«¯ç‚¹
- [ ] è¾“å…¥å®Œæ•´ URL: `https://your-domain.vercel.app/api/payment/webhook`
- [ ] é€‰æ‹©éœ€è¦çš„äº‹ä»¶
- [ ] ä¿å­˜å¹¶å¤åˆ¶ç­¾åå¯†é’¥
- [ ] åœ¨ Vercel æ·»åŠ ç¯å¢ƒå˜é‡ `STRIPE_WEBHOOK_SECRET`
- [ ] é‡æ–°éƒ¨ç½²é¡¹ç›®
- [ ] æµ‹è¯•: åœ¨ Stripe Dashboard å‘é€æµ‹è¯• webhook
- [ ] éªŒè¯: æ£€æŸ¥æ•°æ®åº“æˆ– Vercel æ—¥å¿—

---

## ğŸš¦ å½“å‰ä½ åº”è¯¥åšä»€ä¹ˆ

### ç°åœ¨ï¼ˆæœ¬åœ°å¼€å‘é˜¶æ®µï¼‰

**ä¸éœ€è¦åœ¨ Stripe Dashboard è®¾ç½® Webhookï¼**

åªéœ€è¦ï¼š

```bash
# 1. å®‰è£… Stripe CLI
scoop install stripe

# 2. ç™»å½•
stripe login

# 3. å¯åŠ¨ Webhook è½¬å‘
stripe listen --forward-to localhost:3000/api/payment/webhook

# 4. å¤åˆ¶è¾“å‡ºçš„ whsec_xxx åˆ° .env.local

# 5. é‡å¯å¼€å‘æœåŠ¡å™¨
npm run dev
```

### å°†æ¥ï¼ˆéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒåï¼‰

**éœ€è¦åœ¨ Stripe Dashboard è®¾ç½® Webhookï¼**

è®¿é—®: https://dashboard.stripe.com/webhooks

æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤é…ç½®ã€‚

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: æˆ‘ç°åœ¨å°±æƒ³åœ¨ Stripe Dashboard è®¾ç½®å¯ä»¥å—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†æ²¡æœ‰å¿…è¦ã€‚å› ä¸ºï¼š
- Stripe æ— æ³•è®¿é—® `localhost`
- å³ä½¿è®¾ç½®äº†ä¹Ÿä¸ä¼šå·¥ä½œ
- æœ¬åœ°å¼€å‘ä½¿ç”¨ `stripe listen` æ›´æ–¹ä¾¿

### Q2: æµ‹è¯•æ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼çš„ Webhook éœ€è¦åˆ†åˆ«è®¾ç½®å—ï¼Ÿ

**A**: æ˜¯çš„ï¼
- **æµ‹è¯•æ¨¡å¼**: ç”¨äºå¼€å‘å’Œæµ‹è¯•ï¼Œä½¿ç”¨æµ‹è¯• API å¯†é’¥
- **ç”Ÿäº§æ¨¡å¼**: ç”¨äºæ­£å¼ä¸Šçº¿ï¼Œä½¿ç”¨ç”Ÿäº§ API å¯†é’¥
- ä¸¤è€…çš„ Webhook ç«¯ç‚¹å’Œç­¾åå¯†é’¥æ˜¯ç‹¬ç«‹çš„

### Q3: æˆ‘å¯ä»¥åŒæ—¶ä½¿ç”¨ stripe listen å’Œ Dashboard é…ç½®å—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†é€šå¸¸ä¸éœ€è¦ï¼š
- æœ¬åœ°å¼€å‘: åªç”¨ `stripe listen`
- ç”Ÿäº§ç¯å¢ƒ: åªç”¨ Dashboard é…ç½®
- å¦‚æœåŒæ—¶é…ç½®ï¼ŒStripe ä¼šå‘ä¸¤ä¸ªç«¯ç‚¹éƒ½å‘é€äº‹ä»¶

### Q4: ç­¾åå¯†é’¥ (whsec_xxx) æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

**A**: ç”¨äºéªŒè¯ Webhook çš„çœŸå®æ€§ï¼š
- ç¡®ä¿è¯·æ±‚ç¡®å®æ¥è‡ª Stripe
- é˜²æ­¢æ¶æ„è¯·æ±‚ä¼ªé€ æ”¯ä»˜æˆåŠŸ
- è¿™æ˜¯å®‰å…¨æ€§çš„é‡è¦ä¿éšœ

---

## ğŸ¯ æ€»ç»“

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| ç°åœ¨éœ€è¦åœ¨ Stripe Dashboard è®¾ç½®å—ï¼Ÿ | âŒ ä¸éœ€è¦ |
| ä½¿ç”¨ä»€ä¹ˆæ–¹æ³•ï¼Ÿ | âœ… ä½¿ç”¨ `stripe listen` |
| åœ¨å“ªé‡Œè®¾ç½®ï¼Ÿ | åœ¨å‘½ä»¤è¡Œè¿è¡Œ `stripe listen` |
| å°†æ¥éƒ¨ç½²åéœ€è¦è®¾ç½®å—ï¼Ÿ | âœ… éœ€è¦ |
| åœ¨å“ªé‡Œè®¾ç½®ï¼Ÿ | https://dashboard.stripe.com/webhooks |

---

**ä¸‹ä¸€æ­¥**: æŒ‰ç…§ `WEBHOOK_SETUP_GUIDE.md` è®¾ç½® Stripe CLIï¼

