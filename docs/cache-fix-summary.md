# ç¼“å­˜å¤§å°é™åˆ¶é—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜

### é”™è¯¯ä¿¡æ¯
```
Error: Failed to set Next.js data cache, items over 2MB can not be cached (4316667 bytes)
```

### æ ¹æœ¬åŸå› 
- Next.js `unstable_cache` æœ‰ **2MB å¤§å°é™åˆ¶**
- æˆ‘ä»¬ç¼“å­˜äº† 50 æ¡ try-on ä»»åŠ¡è®°å½•
- æ¯æ¡è®°å½•åŒ…å«å›¾ç‰‡ URLï¼ˆVercel Blob çš„é•¿ URLï¼‰
- æ€»æ•°æ®é‡ï¼š**4.3MB** > 2MB é™åˆ¶ âŒ

## âœ… è§£å†³æ–¹æ¡ˆ

### ç­–ç•¥ï¼šåˆ†ç¦»ç¼“å­˜

**æ ¸å¿ƒæ€æƒ³**ï¼šåªç¼“å­˜è½»é‡çº§æ•°æ®ï¼Œå¤§æ•°æ®ç›´æ¥æŸ¥è¯¢

```typescript
// âŒ ä¹‹å‰ï¼šç¼“å­˜æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ä»»åŠ¡ï¼‰
const userWithTasks = await unstable_cache(
  async () => {
    return await prisma.user.findUnique({
      where: { id: userId },
      include: {
        tryOnTasks: { take: 50 }  // åŒ…å« 50 æ¡ä»»åŠ¡ï¼Œ4.3MB âŒ
      }
    })
  }
)()

// âœ… ç°åœ¨ï¼šåˆ†ç¦»ç¼“å­˜
const [currentUser, allTasks] = await Promise.all([
  getUserBasicData(userId),  // ç¼“å­˜ï¼šç”¨æˆ·ä¿¡æ¯ < 1KB âœ…
  getUserTasks(userId),       // ä¸ç¼“å­˜ï¼šä»»åŠ¡æ•°æ®ï¼Œç›´æ¥æŸ¥è¯¢
])
```

### å®æ–½ç»†èŠ‚

#### 1. ç¼“å­˜ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆè½»é‡çº§ï¼‰

```typescript
function getUserBasicData(userId: string) {
  return unstable_cache(
    async () => {
      return await prisma.user.findUnique({
        where: { id: userId },
        select: {
          isPremium: true,           // Boolean
          premiumExpiresAt: true,    // Date
          freeTrialsUsed: true,      // Number
        },
      })
    },
    [`user-basic-${userId}`],
    {
      revalidate: 60,
      tags: [`user-${userId}`, 'dashboard'],
    }
  )()
}
```

**æ•°æ®å¤§å°**ï¼š< 1KB âœ…

#### 2. ç›´æ¥æŸ¥è¯¢ä»»åŠ¡æ•°æ®ï¼ˆä¸ç¼“å­˜ï¼‰

```typescript
async function getUserTasks(userId: string) {
  return await prisma.tryOnTask.findMany({
    where: { userId },
    orderBy: { createdAt: "desc" },
    take: 50,
    select: {
      id: true,
      status: true,
      userImageUrl: true,      // é•¿ URL
      resultImageUrl: true,    // é•¿ URL
      createdAt: true,
    },
  })
}
```

**æ•°æ®å¤§å°**ï¼šå¯èƒ½ > 2MBï¼Œä¸ç¼“å­˜ âœ…

#### 3. å¹¶è¡ŒæŸ¥è¯¢ä¿æŒæ€§èƒ½

```typescript
const [currentUser, allTasks] = await Promise.all([
  getUserBasicData(session.user.id),  // ç¼“å­˜æŸ¥è¯¢
  getUserTasks(session.user.id),       // æ•°æ®åº“æŸ¥è¯¢
])
```

**æ€§èƒ½**ï¼š
- ç”¨æˆ·ä¿¡æ¯ï¼šä»ç¼“å­˜è¯»å–ï¼ˆ< 100msï¼‰
- ä»»åŠ¡æ•°æ®ï¼šæ•°æ®åº“æŸ¥è¯¢ï¼ˆ100-300msï¼‰
- æ€»æ—¶é—´ï¼šmax(100ms, 300ms) = 300ms âœ…

## ğŸ“Š æ•ˆæœå¯¹æ¯”

### æ•°æ®å¤§å°

| æ•°æ®ç±»å‹ | ä¹‹å‰ | ç°åœ¨ | çŠ¶æ€ |
|---------|------|------|------|
| ç”¨æˆ·ä¿¡æ¯ | åŒ…å«åœ¨ 4.3MB ä¸­ | < 1KB | âœ… å¯ç¼“å­˜ |
| ä»»åŠ¡æ•°æ® | åŒ…å«åœ¨ 4.3MB ä¸­ | ~4MB | âš ï¸ ä¸ç¼“å­˜ |
| æ€»ç¼“å­˜å¤§å° | 4.3MB âŒ | < 1KB âœ… | âœ… ç¬¦åˆé™åˆ¶ |

### æ€§èƒ½å½±å“

| åœºæ™¯ | ä¹‹å‰ï¼ˆç¼“å­˜å¤±è´¥ï¼‰ | ç°åœ¨ï¼ˆåˆ†ç¦»ç¼“å­˜ï¼‰ | å½±å“ |
|------|-----------------|-----------------|------|
| é¦–æ¬¡è®¿é—® | ~10ç§’ | ~10ç§’ | æ— å˜åŒ– |
| åç»­è®¿é—® | ~10ç§’ï¼ˆç¼“å­˜å¤±è´¥ï¼‰ | ~300ms | âœ… æ”¹å–„ 97% |
| æ”¯ä»˜åè®¿é—® | ~10ç§’ | ~300ms | âœ… æ”¹å–„ 97% |

### ç¼“å­˜æ¸…é™¤

| æ“ä½œ | æ¸…é™¤å†…å®¹ | æ•ˆæœ |
|------|---------|------|
| æ”¯ä»˜æˆåŠŸ | `user-${userId}` | âœ… ç”¨æˆ·ä¿¡æ¯ç«‹å³æ›´æ–° |
| ä½¿ç”¨è¯•æˆ´ | `user-${userId}` | âœ… å‰©ä½™æ¬¡æ•°ç«‹å³æ›´æ–° |
| è®¢é˜…å˜æ›´ | `user-${userId}` | âœ… ä¼šå‘˜çŠ¶æ€ç«‹å³æ›´æ–° |

## ğŸ¯ ä¼˜åŠ¿

### 1. **è§£å†³ç¼“å­˜é™åˆ¶** âœ…
- ç¼“å­˜æ•°æ® < 1KBï¼Œè¿œä½äº 2MB é™åˆ¶
- ä¸ä¼šå†å‡ºç°ç¼“å­˜å¤±è´¥é”™è¯¯

### 2. **ä¿æŒæ€§èƒ½ä¼˜åŒ–** âœ…
- ç”¨æˆ·ä¿¡æ¯ä»ç¼“å­˜è¯»å–ï¼ˆ< 100msï¼‰
- ä»»åŠ¡æ•°æ®å¹¶è¡ŒæŸ¥è¯¢ï¼ˆ100-300msï¼‰
- æ€»å“åº”æ—¶é—´ ~300msï¼ˆvs ä¹‹å‰ 10ç§’ï¼‰

### 3. **ä¿æŒæ•°æ®å®æ—¶æ€§** âœ…
- æ”¯ä»˜/ä½¿ç”¨åç«‹å³æ¸…é™¤ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
- ä¸‹æ¬¡è®¿é—®è·å–æœ€æ–°çŠ¶æ€
- ä»»åŠ¡æ•°æ®å§‹ç»ˆæ˜¯æœ€æ–°çš„ï¼ˆä¸ç¼“å­˜ï¼‰

### 4. **æ›´åˆç†çš„æ¶æ„** âœ…
- è½»é‡çº§æ•°æ®ç¼“å­˜ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
- å¤§æ•°æ®ç›´æ¥æŸ¥è¯¢ï¼ˆä»»åŠ¡åˆ—è¡¨ï¼‰
- ç¬¦åˆæœ€ä½³å®è·µ

## ğŸ” ä¸ºä»€ä¹ˆä»»åŠ¡æ•°æ®ä¸ç¼“å­˜ï¼Ÿ

### åŸå› åˆ†æ

1. **æ•°æ®é‡å¤§**
   - 50 æ¡ä»»åŠ¡ Ã— 2 ä¸ªå›¾ç‰‡ URL Ã— é•¿ URL = ~4MB
   - è¶…è¿‡ Next.js 2MB ç¼“å­˜é™åˆ¶

2. **å˜åŒ–é¢‘ç¹**
   - ç”¨æˆ·æ¯æ¬¡è¯•æˆ´éƒ½ä¼šæ–°å¢ä»»åŠ¡
   - ç¼“å­˜å‘½ä¸­ç‡ä½

3. **æŸ¥è¯¢é€Ÿåº¦å¯æ¥å—**
   - æœ‰ç´¢å¼•ï¼š`@@index([userId, createdAt(sort: Desc)])`
   - æŸ¥è¯¢æ—¶é—´ï¼š100-300ms
   - å¯æ¥å—çš„æ€§èƒ½

### æƒè¡¡å†³ç­–

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‰æ‹© |
|------|------|------|------|
| ç¼“å­˜æ‰€æœ‰æ•°æ® | æœ€å¿« | è¶…è¿‡ 2MB é™åˆ¶ âŒ | âŒ |
| åªç¼“å­˜ç”¨æˆ·ä¿¡æ¯ | ç¬¦åˆé™åˆ¶ï¼Œå®æ—¶æ€§å¥½ | ä»»åŠ¡éœ€æŸ¥è¯¢ | âœ… |
| ä¸ä½¿ç”¨ç¼“å­˜ | æ•°æ®æœ€æ–° | æ€§èƒ½å·®ï¼ˆ10ç§’ï¼‰ | âŒ |

## ğŸ“ æœ€ä½³å®è·µ

### ç¼“å­˜ç­–ç•¥å»ºè®®

1. **åªç¼“å­˜è½»é‡çº§æ•°æ®**
   - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
   - é…ç½®æ•°æ®
   - å…ƒæ•°æ®

2. **ä¸ç¼“å­˜å¤§æ•°æ®**
   - åˆ—è¡¨æ•°æ®ï¼ˆå°¤å…¶æ˜¯åŒ…å« URLï¼‰
   - å›¾ç‰‡/æ–‡ä»¶è·¯å¾„
   - å¤§æ–‡æœ¬å†…å®¹

3. **ä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢**
   - ç¼“å­˜æŸ¥è¯¢ + æ•°æ®åº“æŸ¥è¯¢å¹¶è¡Œ
   - ä¿æŒæ€§èƒ½

4. **åˆç†è®¾ç½®ç¼“å­˜æ—¶é—´**
   - é¢‘ç¹å˜åŒ–ï¼šçŸ­æ—¶é—´ï¼ˆ30-60ç§’ï¼‰
   - ç¨³å®šæ•°æ®ï¼šé•¿æ—¶é—´ï¼ˆ5-10åˆ†é’Ÿï¼‰

## ğŸ‰ æ€»ç»“

### é—®é¢˜
- âŒ ç¼“å­˜æ•°æ® 4.3MB > 2MB é™åˆ¶
- âŒ å¯¼è‡´ç¼“å­˜å¤±è´¥ï¼Œæ€§èƒ½é€€åŒ–

### è§£å†³
- âœ… åˆ†ç¦»ç¼“å­˜ï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆ< 1KBï¼‰ç¼“å­˜ï¼Œä»»åŠ¡æ•°æ®ä¸ç¼“å­˜
- âœ… å¹¶è¡ŒæŸ¥è¯¢ä¿æŒæ€§èƒ½
- âœ… ç¬¦åˆ Next.js ç¼“å­˜é™åˆ¶

### æ•ˆæœ
- âœ… æ€§èƒ½ï¼š~300msï¼ˆvs ä¹‹å‰ 10ç§’ï¼‰
- âœ… å®æ—¶æ€§ï¼šæ”¯ä»˜/ä½¿ç”¨åç«‹å³ç”Ÿæ•ˆ
- âœ… ç¨³å®šæ€§ï¼šæ— ç¼“å­˜é”™è¯¯

**è¿™æ˜¯ä¸€ä¸ªæ›´åˆç†ã€æ›´ç¨³å®šçš„ç¼“å­˜æ¶æ„ï¼** ğŸš€

