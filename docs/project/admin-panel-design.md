# 后台运维系统 - 业务需求与技术设计文档

本文档旨在明确 VisuTry 后台运维系统的业务需求和技术实现方案。

---

## 1. 业务需求分析文档 (BRD)

### 1.1. 项目背景与目标

**背景:** VisuTry 作为一个线上虚拟试戴眼镜的独立站，随着业务的增长，日常运营工作（如用户管理、订单处理、客户服务）日益增多。目前，运营人员需要登录多个独立的第三方服务后台（Vercel, Neon DB, Stripe）来处理日常事务，这不仅效率低下，而且增加了操作失误和安全风险。

**目标:** 开发一个集中的、内部使用的后台运维系统（Admin Panel），旨在：
*   **提升效率:** 将核心的业务运维操作整合到一个统一的界面中。
*   **增强安全:** 通过统一的权限控制，确保只有授权的内部员工才能访问和操作业务数据，避免直接暴露数据库和支付网关后台。
*   **优化体验:** 提供一个简洁、直观、用户体验良好的操作界面，降低运营人员的使用门槛。
*   **数据洞察:** 集中展示关键业务指标，为运营决策提供数据支持。

### 1.2. 目标用户

*   **VisuTry 业务运维人员:** 包括客服、运营经理、财务人员等。他们需要处理用户的问询、订单的状态更新、退款申请等。

### 1.3. 功能需求 (Functional Requirements)

**MVP (最小可行产品) 阶段，我们将聚焦于最高频、最核心的功能：**

| 模块 | 功能点 | 详细描述 | 优先级 |
| :--- | :--- | :--- | :--- |
| **1. 安全与认证** | 基于角色的访问控制 (RBAC) | - 只有被授予“管理员”角色的用户才能访问后台运维系统。<br>- 复用现有的 NextAuth.js 和 Auth0 认证体系。 | **极高** |
| | 操作日志 | - (暂缓，二期实现) 记录关键操作（如退款、修改订单状态），便于审计。 | 中 |
| **2. 仪表盘 (Dashboard)** | 关键指标 (KPIs) 概览 | - 实时展示核心业务数据，如：今日新增用户、今日订单量、今日销售额、待处理订单数。 | **高** |
| | 最近活动 | - 显示最近的几笔订单或用户注册信息，方便快速了解动态。 | 中 |
| **3. 用户管理** | 用户列表 | - 以表格形式展示所有注册用户，支持分页浏览。<br>- 关键信息包括：用户ID、邮箱、姓名、注册时间。 | **高** |
| | 搜索与筛选 | - 支持按邮箱或姓名模糊搜索用户。 | **高** |
| | 查看用户详情 | - 点击用户可进入详情页，查看其基本信息、历史订单列表。 | **高** |
| **4. 订单管理** | 订单列表 | - 以表格形式展示所有订单，支持分页。<br>- 关键信息包括：订单号、用户、下单时间、订单金额、订单状态（待支付/待发货/已发货/已完成/已取消）。 | **极高** |
| | 搜索与筛选 | - 支持按订单号、用户邮箱或订单状态进行搜索和筛选。 | **极高** |
| | 查看订单详情 | - 点击订单可进入详情页，查看订单的详细商品、收货地址、支付信息（来自Stripe的状态）、物流信息（如有）。 | **极高** |
| | 修改订单状态 | - 运营人员可以手动将订单状态从“待发货”更新为“已发货”（并填写物流单号）。 | **高** |
| **5. 支付管理 (集成Stripe)** | 查看支付状态 | - 在订单详情中清晰地展示该笔订单在Stripe的支付状态（如 `succeeded`, `pending`, `failed`）。 | **高** |
| | 快捷退款 | - (暂缓，二期实现) 在订单详情页提供一个“退款”按钮，调用Stripe API处理退款流程，简化操作。 | 中 |
| | 访问Stripe后台 | - 在支付信息旁提供一个直接跳转到Stripe对应交易页面的链接，方便处理复杂争议。 | **高** |

### 1.4. 非功能需求 (Non-Functional Requirements)

*   **安全性:** 所有后台页面的访问必须经过严格的身份和权限验证。API 也需要有同样的保护。
*   **易用性:** 界面设计遵循简洁、直观的原则，交互流程清晰，减少误操作的可能性。
*   **性能:** 列表数据的加载速度要快，对大量数据采用服务端分页，避免前端卡顿。
*   **可靠性:** 对数据的修改操作需要有二次确认（如弹窗提示），保证操作的准确性。

---

## 2. 技术设计文档 (TDD)

### 2.1. 整体架构

我们将采用与主应用相同的技术栈，在现有 Next.js 项目中创建一个新的“区域” (Area) 来承载后台系统。

*   **物理路径:** 所有后台相关的页面和API将存放在 `app/admin/` 目录下。
*   **URL路径:** 用户将通过 `https://visutry.com/admin` 访问后台系统。
*   **数据流:**
    1.  管理员访问 `/admin`。
    2.  Next.js 中间件 (`middleware.ts`) 拦截请求，验证用户是否已登录且拥有 `ADMIN` 角色。
    3.  验证通过后，渲染 React Server Components (RSC) 页面。
    4.  页面组件在服务端通过 Prisma 调用 Neon 数据库获取数据并渲染。
    5.  客户端的交互（如搜索、排序）通过 Client Components 发起对 Next.js API Routes 的请求。
    6.  API Routes 同样会进行权限校验，然后执行业务逻辑。

### 2.2. 技术选型

*   **前端:** Next.js (App Router), React, TypeScript, Tailwind CSS。
*   **UI 组件库:** 采用 **Shadcn/UI**。它与 Tailwind CSS 无缝集成，提供高质量、可访问的组件（如 Table, Dropdown, Dialog），能快速构建出专业且一致的界面。
*   **后端 API:** Next.js API Routes。
*   **认证与授权:** NextAuth.js (复用现有配置), Auth0 Provider。
*   **数据库 ORM:** Prisma (复用现有配置)。
*   **部署:** Vercel (与主应用一起部署)。

### 2.3. 数据库设计 (Schema 变更)

为了支持管理员角色，我们需要在 `prisma/schema.prisma` 的 `User` 模型中增加一个字段：

```prisma
model User {
  // ... existing fields
  id        String   @id @default(cuid())
  name      String?
  email     String?  @unique
  // ...

  // 新增字段
  role      UserRole @default(USER)
}

// 新增枚举
enum UserRole {
  USER
  ADMIN
}
```
*   **数据迁移:** 需要创建一个新的 Prisma migration 来应用此变更。
*   **管理员指定:** 初期，我们将通过一个脚本或手动在数据库中将指定用户的 `role` 设置为 `ADMIN`。

### 2.4. 核心实现方案

**1. 认证与路由保护:**
*   在项目根目录创建 `middleware.ts` 文件。
*   该中间件将匹配 `'/admin/:path*'` 的路由。
*   在中间件中，获取 `next-auth` 的 session 信息。
*   检查 `session.user.role` 是否为 `ADMIN`。如果不是或未登录，则重定向到主应用的登录页或首页。

**2. 页面与组件结构:**
*   `app/admin/layout.tsx`: 后台系统的整体布局，包含一个侧边栏导航和一个顶部用户信息栏。
*   `app/admin/dashboard/page.tsx`: 仪表盘页面，使用 RSC 获取统计数据。
*   `app/admin/users/page.tsx`: 用户管理主页面。
    *   `components/admin/user-data-table.tsx`: 一个客户端组件，负责用户数据的展示、分页、搜索和筛选逻辑。
*   `app/admin/orders/page.tsx`: 订单管理主页面。
    *   `components/admin/order-data-table.tsx`: 订单数据的客户端组件。

**3. API 端点设计:**
所有API端点都会有权限校验的中间逻辑。

*   `GET /api/admin/stats`: 获取仪表盘的统计数据。
*   `GET /api/admin/users?page=1&limit=10&search=...`: 获取用户列表，支持分页和搜索。
*   `GET /api/admin/orders?status=PENDING`: 获取订单列表，支持筛选。
*   `PATCH /api/admin/orders/[orderId]`: 更新订单信息（如状态）。
