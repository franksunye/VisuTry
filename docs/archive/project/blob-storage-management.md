# Blob Storage ç®¡ç†åŠŸèƒ½æ–‡æ¡£

## ğŸ“… å®æ–½æ—¥æœŸ
2025-10-21

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†å®Œæ•´çš„ Vercel Blob Storage ç®¡ç†ç³»ç»Ÿï¼Œå¸®åŠ©ç®¡ç†å‘˜æœ‰æ•ˆç®¡ç†å­˜å‚¨ç©ºé—´ã€æ§åˆ¶æˆæœ¬ã€æ¸…ç†å­¤ç«‹æ–‡ä»¶ã€‚

## âœ… å·²å®ç°åŠŸèƒ½

### 1. Storage ç®¡ç†é¡µé¢ (`/admin/storage`)

#### å­˜å‚¨ç»Ÿè®¡ä»ªè¡¨ç›˜
- **Total Files**: æ€»æ–‡ä»¶æ•°å’Œæ€»å¤§å°
- **Referenced Files**: æ•°æ®åº“ä¸­å¼•ç”¨çš„æ–‡ä»¶æ•°
- **Orphaned Files**: å­¤ç«‹æ–‡ä»¶æ•°å’Œæµªè´¹çš„ç©ºé—´
- **Storage Usage**: å­˜å‚¨ä½¿ç”¨é‡å’Œå…è´¹é¢åº¦å æ¯”

#### æ–‡ä»¶ç®¡ç†åŠŸèƒ½
- âœ… æ–‡ä»¶åˆ—è¡¨å±•ç¤ºï¼ˆpathname, size, upload timeï¼‰
- âœ… æœç´¢æ–‡ä»¶ï¼ˆæŒ‰è·¯å¾„æˆ– URLï¼‰
- âœ… ç­›é€‰æ˜¾ç¤ºï¼ˆå…¨éƒ¨æ–‡ä»¶ / ä»…å­¤ç«‹æ–‡ä»¶ï¼‰
- âœ… æ‰¹é‡é€‰æ‹©æ–‡ä»¶
- âœ… æ‰¹é‡åˆ é™¤æ–‡ä»¶ï¼ˆæœ€å¤š 100 ä¸ªï¼‰
- âœ… æŸ¥çœ‹æ–‡ä»¶ï¼ˆåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼‰

#### å­¤ç«‹æ–‡ä»¶æ¸…ç†
- âœ… ä¸€é”®æ£€æµ‹å­¤ç«‹æ–‡ä»¶
- âœ… é¢„è§ˆæ¸…ç†ç»“æœï¼ˆDry Runï¼‰
- âœ… æ‰§è¡Œæ¸…ç†æ“ä½œ
- âœ… æ˜¾ç¤ºæ¸…ç†ç»Ÿè®¡ï¼ˆæ–‡ä»¶æ•°ã€é‡Šæ”¾ç©ºé—´ï¼‰

### 2. API ç«¯ç‚¹

#### `/api/admin/blob/stats` (GET)
è·å–å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯

**å“åº”æ•°æ®ï¼š**
```json
{
  "success": true,
  "data": {
    "totalFiles": 150,
    "totalSize": 52428800,
    "totalSizeMB": "50.00",
    "orphanedFiles": 12,
    "orphanedSize": 5242880,
    "orphanedSizeMB": "5.00",
    "referencedFiles": 138,
    "filesByType": {
      "jpg": 100,
      "png": 50
    },
    "topUsers": [
      { "userId": "user123", "count": 45 }
    ]
  }
}
```

#### `/api/admin/blob/list` (GET)
åˆ—å‡ºæ‰€æœ‰ Blob æ–‡ä»¶

**æŸ¥è¯¢å‚æ•°ï¼š**
- `prefix`: æ–‡ä»¶è·¯å¾„å‰ç¼€ï¼ˆå¯é€‰ï¼‰
- `limit`: è¿”å›æ•°é‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰
- `orphaned`: ä»…æ˜¾ç¤ºå­¤ç«‹æ–‡ä»¶ï¼ˆtrue/falseï¼‰

**å“åº”æ•°æ®ï¼š**
```json
{
  "success": true,
  "data": {
    "files": [
      {
        "url": "https://...",
        "pathname": "try-on/user123/1234567890-user.jpg",
        "size": 524288,
        "sizeMB": "0.50",
        "uploadedAt": "2025-10-21T10:00:00Z",
        "downloadUrl": "https://..."
      }
    ],
    "total": 150
  }
}
```

#### `/api/admin/blob/delete` (POST)
åˆ é™¤æŒ‡å®šçš„æ–‡ä»¶

**è¯·æ±‚ä½“ï¼š**
```json
{
  "urls": [
    "https://blob.vercel-storage.com/...",
    "https://blob.vercel-storage.com/..."
  ]
}
```

**é™åˆ¶ï¼š**
- æœ€å¤šä¸€æ¬¡åˆ é™¤ 100 ä¸ªæ–‡ä»¶
- ä»… ADMIN è§’è‰²å¯è®¿é—®

**å“åº”æ•°æ®ï¼š**
```json
{
  "success": true,
  "data": {
    "deleted": 2
  }
}
```

#### `/api/admin/blob/cleanup` (POST)
æ¸…ç†å­¤ç«‹æ–‡ä»¶

**è¯·æ±‚ä½“ï¼š**
```json
{
  "dryRun": true  // true=é¢„è§ˆ, false=æ‰§è¡Œ
}
```

**å“åº”æ•°æ®ï¼š**
```json
{
  "success": true,
  "data": {
    "dryRun": true,
    "orphanedFiles": 12,
    "orphanedSize": 5242880,
    "orphanedSizeMB": "5.00",
    "deletedCount": 0,
    "files": [
      {
        "url": "https://...",
        "pathname": "try-on/...",
        "size": 524288,
        "uploadedAt": "2025-10-21T10:00:00Z"
      }
    ]
  }
}
```

### 3. Try-On ä»»åŠ¡ç®¡ç†

#### `/api/admin/try-on/[id]` (GET)
è·å– Try-On ä»»åŠ¡è¯¦æƒ…ï¼ˆåŒ…å«å›¾ç‰‡ URLï¼‰

**å“åº”æ•°æ®ï¼š**
```json
{
  "success": true,
  "data": {
    "id": "task123",
    "userId": "user123",
    "userImageUrl": "https://...",
    "glassesImageUrl": "https://...",
    "resultImageUrl": "https://...",
    "status": "COMPLETED",
    "errorMessage": null,
    "createdAt": "2025-10-21T10:00:00Z",
    "updatedAt": "2025-10-21T10:05:00Z",
    "user": {
      "id": "user123",
      "name": "John Doe",
      "email": "john@example.com",
      "createdAt": "2025-01-01T00:00:00Z"
    }
  }
}
```

#### `/api/admin/try-on/[id]` (DELETE)
åˆ é™¤ Try-On ä»»åŠ¡åŠå…¶ç›¸å…³æ–‡ä»¶

**åŠŸèƒ½ï¼š**
1. åˆ é™¤æ•°æ®åº“ä¸­çš„ä»»åŠ¡è®°å½•
2. åˆ é™¤ Blob Storage ä¸­çš„ç›¸å…³æ–‡ä»¶ï¼ˆç”¨æˆ·å›¾ç‰‡ã€çœ¼é•œå›¾ç‰‡ã€ç»“æœå›¾ç‰‡ï¼‰

**å“åº”æ•°æ®ï¼š**
```json
{
  "success": true,
  "data": {
    "deletedTask": "task123",
    "deletedFiles": 3
  }
}
```

### 4. UI ç»„ä»¶

#### `StorageManager` ç»„ä»¶
**ä½ç½®ï¼š** `src/components/admin/StorageManager.tsx`

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºå­˜å‚¨ç»Ÿè®¡å¡ç‰‡
- æ–‡ä»¶åˆ—è¡¨å’Œæœç´¢
- æ‰¹é‡é€‰æ‹©å’Œåˆ é™¤
- å­¤ç«‹æ–‡ä»¶æ¸…ç†

**çŠ¶æ€ç®¡ç†ï¼š**
- `stats`: å­˜å‚¨ç»Ÿè®¡æ•°æ®
- `files`: æ–‡ä»¶åˆ—è¡¨
- `selectedFiles`: é€‰ä¸­çš„æ–‡ä»¶
- `showOrphaned`: æ˜¯å¦åªæ˜¾ç¤ºå­¤ç«‹æ–‡ä»¶
- `searchTerm`: æœç´¢å…³é”®è¯

#### `TryOnDetailDialog` ç»„ä»¶
**ä½ç½®ï¼š** `src/components/admin/TryOnDetailDialog.tsx`

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤º Try-On ä»»åŠ¡è¯¦æƒ…
- æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
- æ˜¾ç¤ºæ—¶é—´çº¿
- æ˜¾ç¤ºå›¾ç‰‡ URL
- æŒ‰éœ€åŠ è½½å›¾ç‰‡é¢„è§ˆ
- åˆ é™¤ä»»åŠ¡å’Œæ–‡ä»¶

**Propsï¼š**
```typescript
interface TryOnDetailDialogProps {
  taskId: string | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onDeleted?: () => void;
}
```

#### `TryOnHistoryTable` ç»„ä»¶
**ä½ç½®ï¼š** `src/components/admin/TryOnHistoryTable.tsx`

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤º Try-On ä»»åŠ¡åˆ—è¡¨
- æ·»åŠ "View Details"æŒ‰é’®
- é›†æˆ TryOnDetailDialog

## ğŸ”§ æŠ€æœ¯å®ç°

### å­¤ç«‹æ–‡ä»¶æ£€æµ‹ç®—æ³•

```typescript
// 1. è·å–æ‰€æœ‰ Blob æ–‡ä»¶
const { blobs } = await list();

// 2. è·å–æ•°æ®åº“ä¸­æ‰€æœ‰å›¾ç‰‡ URL
const tasks = await prisma.tryOnTask.findMany({
  select: {
    userImageUrl: true,
    glassesImageUrl: true,
    resultImageUrl: true,
  },
});

// 3. æ„å»º URL é›†åˆ
const dbUrls = new Set<string>();
tasks.forEach(task => {
  if (task.userImageUrl) dbUrls.add(task.userImageUrl);
  if (task.glassesImageUrl) dbUrls.add(task.glassesImageUrl);
  if (task.resultImageUrl) dbUrls.add(task.resultImageUrl);
});

// 4. æ‰¾å‡ºå­¤ç«‹æ–‡ä»¶
const orphanedFiles = blobs.filter(blob => !dbUrls.has(blob.url));
```

### æ‰¹é‡åˆ é™¤å®ç°

```typescript
// åˆ†æ‰¹åˆ é™¤ï¼ˆæ¯æ‰¹ 100 ä¸ªï¼‰
const batchSize = 100;
for (let i = 0; i < urlsToDelete.length; i += batchSize) {
  const batch = urlsToDelete.slice(i, i + batchSize);
  await del(batch);
}
```

### æƒé™æ§åˆ¶

æ‰€æœ‰ API ç«¯ç‚¹éƒ½åŒ…å«æƒé™éªŒè¯ï¼š

```typescript
const session = await getServerSession(authOptions);
if (!session || !session.user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}

if (session.user.role !== 'ADMIN') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
}
```

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å®šæœŸæ¸…ç†å­¤ç«‹æ–‡ä»¶
1. è®¿é—® `/admin/storage`
2. ç‚¹å‡» "Cleanup Orphaned Files" æŒ‰é’®
3. æŸ¥çœ‹é¢„è§ˆç»“æœï¼ˆæ–‡ä»¶æ•°ã€é‡Šæ”¾ç©ºé—´ï¼‰
4. ç¡®è®¤åæ‰§è¡Œæ¸…ç†

### åœºæ™¯ 2: æŸ¥æ‰¾ç‰¹å®šç”¨æˆ·çš„æ–‡ä»¶
1. åœ¨æœç´¢æ¡†è¾“å…¥ç”¨æˆ· ID
2. æŸ¥çœ‹è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ–‡ä»¶
3. å¯é€‰ï¼šæ‰¹é‡åˆ é™¤

### åœºæ™¯ 3: æŸ¥çœ‹ Try-On ä»»åŠ¡è¯¦æƒ…
1. è®¿é—®ç”¨æˆ·è¯¦æƒ…é¡µ `/admin/users/[id]`
2. åœ¨ Try-On History åˆ—è¡¨ä¸­ç‚¹å‡» "View Details"
3. æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…å’Œå›¾ç‰‡
4. å¯é€‰ï¼šåˆ é™¤ä»»åŠ¡å’Œæ–‡ä»¶

### åœºæ™¯ 4: ç›‘æ§å­˜å‚¨ä½¿ç”¨
1. è®¿é—® `/admin/storage`
2. æŸ¥çœ‹ç»Ÿè®¡å¡ç‰‡
3. ç›‘æ§å­˜å‚¨ä½¿ç”¨é‡å’Œå…è´¹é¢åº¦å æ¯”
4. åŠæ—¶æ¸…ç†å­¤ç«‹æ–‡ä»¶

## ğŸ”’ å®‰å…¨æ€§

### æƒé™æ§åˆ¶
- âœ… æ‰€æœ‰ API ç«¯ç‚¹éœ€è¦ ADMIN è§’è‰²
- âœ… ä¸­é—´ä»¶è‡ªåŠ¨éªŒè¯ `/admin` è·¯ç”±
- âœ… å®¢æˆ·ç«¯ç»„ä»¶éªŒè¯ç”¨æˆ·æƒé™

### æ•°æ®ä¿æŠ¤
- âœ… å›¾ç‰‡é»˜è®¤ä¸æ˜¾ç¤ºï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
- âœ… åˆ é™¤æ“ä½œéœ€è¦ç¡®è®¤å¯¹è¯æ¡†
- âœ… æ‰¹é‡åˆ é™¤æœ‰æ•°é‡é™åˆ¶ï¼ˆ100 ä¸ªï¼‰
- âœ… Dry Run æ¨¡å¼é˜²æ­¢è¯¯åˆ 

### æ“ä½œæ—¥å¿—
- âœ… æ‰€æœ‰æ“ä½œéƒ½æœ‰ console.log è®°å½•
- âœ… åŒ…å«æ“ä½œç±»å‹ã€æ–‡ä»¶æ•°ã€ç”¨æˆ·ä¿¡æ¯

## ğŸ’° æˆæœ¬ä¼˜åŒ–

### Vercel Blob å®šä»·
- **å…è´¹é¢åº¦**: 1GB å­˜å‚¨ + 100GB æµé‡/æœˆ
- **è¶…å‡ºå**: $0.15/GB å­˜å‚¨ + $0.30/GB æµé‡

### ä¼˜åŒ–ç­–ç•¥
1. **å®šæœŸæ¸…ç†å­¤ç«‹æ–‡ä»¶**
   - å»ºè®®ï¼šæ¯å‘¨æ¸…ç†ä¸€æ¬¡
   - é¢„æœŸæ•ˆæœï¼šèŠ‚çœ 5-10% å­˜å‚¨ç©ºé—´

2. **ç›‘æ§å­˜å‚¨ä½¿ç”¨**
   - å®æ—¶æŸ¥çœ‹å­˜å‚¨ä½¿ç”¨é‡
   - æ¥è¿‘å…è´¹é¢åº¦æ—¶åŠæ—¶æ¸…ç†

3. **åˆ é™¤å¤±è´¥ä»»åŠ¡çš„æ–‡ä»¶**
   - å¤±è´¥ä»»åŠ¡çš„å›¾ç‰‡é€šå¸¸ä¸å†éœ€è¦
   - å¯ä»¥æ‰‹åŠ¨åˆ é™¤é‡Šæ”¾ç©ºé—´

## ğŸ“ˆ æœªæ¥æ”¹è¿›

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
- [ ] æ·»åŠ è‡ªåŠ¨æ¸…ç†å®šæ—¶ä»»åŠ¡
- [ ] æ·»åŠ å­˜å‚¨ä½¿ç”¨è¶‹åŠ¿å›¾è¡¨
- [ ] æ·»åŠ æ–‡ä»¶å¤§å°æ’åº
- [ ] æ·»åŠ æŒ‰æ—¥æœŸç­›é€‰

### ä¸­æœŸï¼ˆ1-2 æœˆï¼‰
- [ ] æ·»åŠ å­˜å‚¨æˆæœ¬é¢„ä¼°
- [ ] æ·»åŠ æ–‡ä»¶å‹ç¼©åŠŸèƒ½
- [ ] æ·»åŠ æ‰¹é‡ä¸‹è½½åŠŸèƒ½
- [ ] æ·»åŠ æ“ä½œå®¡è®¡æ—¥å¿—

### é•¿æœŸï¼ˆ3-6 æœˆï¼‰
- [ ] é›†æˆ CDN ç¼“å­˜åˆ†æ
- [ ] æ·»åŠ æ™ºèƒ½æ¸…ç†å»ºè®®
- [ ] æ·»åŠ å­˜å‚¨é…é¢ç®¡ç†
- [ ] æ·»åŠ å¤šåŒºåŸŸå­˜å‚¨æ”¯æŒ

## ğŸ§ª æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•
1. âœ… æµ‹è¯•å­˜å‚¨ç»Ÿè®¡æ•°æ®å‡†ç¡®æ€§
2. âœ… æµ‹è¯•å­¤ç«‹æ–‡ä»¶æ£€æµ‹å‡†ç¡®æ€§
3. âœ… æµ‹è¯•æ‰¹é‡åˆ é™¤åŠŸèƒ½
4. âœ… æµ‹è¯• Try-On è¯¦æƒ…æŸ¥çœ‹
5. âœ… æµ‹è¯•æƒé™æ§åˆ¶

### æ€§èƒ½æµ‹è¯•
1. æµ‹è¯•å¤§é‡æ–‡ä»¶ï¼ˆ1000+ï¼‰çš„åˆ—è¡¨æ€§èƒ½
2. æµ‹è¯•æ‰¹é‡åˆ é™¤æ€§èƒ½
3. æµ‹è¯•å­¤ç«‹æ–‡ä»¶æ£€æµ‹æ€§èƒ½

### å®‰å…¨æµ‹è¯•
1. æµ‹è¯•é ADMIN ç”¨æˆ·è®¿é—®
2. æµ‹è¯•æ‰¹é‡åˆ é™¤é™åˆ¶
3. æµ‹è¯• SQL æ³¨å…¥é˜²æŠ¤

## ğŸ“ ä½¿ç”¨æ–‡æ¡£

### ç®¡ç†å‘˜æ“ä½œæŒ‡å—

#### å¦‚ä½•æ¸…ç†å­¤ç«‹æ–‡ä»¶
```
1. ç™»å½• Admin é¢æ¿
2. è®¿é—® Storage é¡µé¢
3. ç‚¹å‡» "Cleanup Orphaned Files"
4. æŸ¥çœ‹é¢„è§ˆç»“æœ
5. ç¡®è®¤åç‚¹å‡» "Cleanup Now"
```

#### å¦‚ä½•æŸ¥çœ‹ç”¨æˆ·çš„ Try-On å›¾ç‰‡
```
1. è®¿é—®ç”¨æˆ·è¯¦æƒ…é¡µ
2. æ»šåŠ¨åˆ° Try-On History éƒ¨åˆ†
3. ç‚¹å‡»ä»»åŠ¡çš„ "View Details" æŒ‰é’®
4. ç‚¹å‡» "Show Images" æŸ¥çœ‹å›¾ç‰‡
```

#### å¦‚ä½•æ‰¹é‡åˆ é™¤æ–‡ä»¶
```
1. è®¿é—® Storage é¡µé¢
2. ä½¿ç”¨æœç´¢æ¡†ç­›é€‰æ–‡ä»¶
3. å‹¾é€‰è¦åˆ é™¤çš„æ–‡ä»¶
4. ç‚¹å‡» "Delete Selected"
5. ç¡®è®¤åˆ é™¤
```

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å®ç°å®Œæˆäº†å®Œæ•´çš„ Blob Storage ç®¡ç†ç³»ç»Ÿï¼Œä¸»è¦æˆå°±ï¼š

1. **åŠŸèƒ½å®Œæ•´æ€§**: å®ç°äº†å­˜å‚¨ç®¡ç†çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
2. **ç”¨æˆ·ä½“éªŒ**: ç›´è§‚çš„ UI å’Œæ¸…æ™°çš„æ“ä½œæµç¨‹
3. **å®‰å…¨æ€§**: å®Œå–„çš„æƒé™æ§åˆ¶å’Œæ“ä½œç¡®è®¤
4. **æˆæœ¬æ§åˆ¶**: æœ‰æ•ˆçš„å­¤ç«‹æ–‡ä»¶æ£€æµ‹å’Œæ¸…ç†
5. **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„ä»£ç ç»“æ„å’Œå®Œå–„çš„æ–‡æ¡£

Storage ç®¡ç†åŠŸèƒ½ç°å·²å®Œå…¨å¯ç”¨ï¼Œå¯ä»¥æœ‰æ•ˆå¸®åŠ©ç®¡ç†å‘˜æ§åˆ¶å­˜å‚¨æˆæœ¬å’Œç®¡ç†æ–‡ä»¶ã€‚

