# VisuTry 集成测试计划

## 📋 测试概述

### 测试目标
验证VisuTry应用的所有核心功能在集成环境中正常工作，确保各个组件之间的交互正确无误。

### 测试范围
- 用户认证和授权
- 文件上传和处理
- AI试戴功能
- 支付流程
- 数据存储和检索
- API安全性

### 测试环境
- **开发环境**: Node.js 18+, Next.js 14
- **测试模式**: Mock服务启用
- **数据库**: Mock数据库
- **外部服务**: 全部使用Mock实现

## 🧪 测试用例

### 1. 认证系统测试

#### 1.1 CSRF令牌管理
- **测试目标**: 验证CSRF保护机制
- **前置条件**: 服务器正常运行
- **测试步骤**:
  1. 访问 `/api/auth/csrf`
  2. 验证返回有效的CSRF令牌
  3. 验证Cookie设置正确
- **预期结果**: 
  - 状态码: 200
  - 返回格式: `{csrfToken: "string"}`
  - 设置必要的Cookie

#### 1.2 Mock登录流程
- **测试目标**: 验证Mock认证提供者
- **前置条件**: 已获取CSRF令牌
- **测试步骤**:
  1. 使用有效CSRF令牌调用登录API
  2. 提供用户类型（free/premium）
  3. 验证登录响应
- **预期结果**:
  - 登录成功
  - 设置会话Cookie
  - 返回正确的用户信息

#### 1.3 会话验证
- **测试目标**: 验证会话管理
- **前置条件**: 已成功登录
- **测试步骤**:
  1. 访问 `/api/auth/session`
  2. 验证会话数据
- **预期结果**:
  - 返回完整的用户信息
  - 包含正确的用户类型和权限

### 2. 文件上传测试

#### 2.1 认证要求
- **测试目标**: 验证上传API的安全性
- **测试步骤**:
  1. 未认证状态下尝试上传文件
  2. 验证返回401错误
- **预期结果**: 拒绝未认证的请求

#### 2.2 有效文件上传
- **测试目标**: 验证正常文件上传流程
- **前置条件**: 已认证用户
- **测试步骤**:
  1. 上传有效的图片文件（JPG/PNG/WebP）
  2. 验证上传响应
- **预期结果**:
  - 状态码: 200
  - 返回文件URL和元数据
  - Mock存储服务正常工作

#### 2.3 文件类型验证
- **测试目标**: 验证文件类型限制
- **测试步骤**:
  1. 尝试上传不支持的文件类型
  2. 验证错误响应
- **预期结果**: 拒绝不支持的文件类型

#### 2.4 文件大小限制
- **测试目标**: 验证文件大小限制
- **测试步骤**:
  1. 上传超过5MB的文件
  2. 验证错误响应
- **预期结果**: 拒绝过大的文件

### 3. AI试戴功能测试

#### 3.1 试戴API认证
- **测试目标**: 验证试戴API安全性
- **测试步骤**:
  1. 未认证状态下调用试戴API
  2. 验证返回401错误
- **预期结果**: 要求用户认证

#### 3.2 试戴流程
- **测试目标**: 验证完整试戴流程
- **前置条件**: 已认证用户
- **测试步骤**:
  1. 提供用户照片和眼镜框架ID
  2. 调用试戴API
  3. 验证处理响应
- **预期结果**:
  - 创建试戴任务
  - 返回任务ID
  - Mock AI服务正常处理

#### 3.3 试戴历史查询
- **测试目标**: 验证历史记录功能
- **前置条件**: 已有试戴记录
- **测试步骤**:
  1. 查询用户试戴历史
  2. 验证分页功能
- **预期结果**:
  - 返回用户的试戴记录
  - 支持分页参数

### 4. 支付功能测试

#### 4.1 支付API认证
- **测试目标**: 验证支付API安全性
- **测试步骤**:
  1. 未认证状态下调用支付API
  2. 验证返回401错误
- **预期结果**: 要求用户认证

#### 4.2 支付会话创建
- **测试目标**: 验证支付流程
- **前置条件**: 已认证用户
- **测试步骤**:
  1. 创建支付会话
  2. 提供价格ID
  3. 验证响应
- **预期结果**:
  - 创建Mock支付会话
  - 返回会话URL和ID

### 5. 数据一致性测试

#### 5.1 用户数据一致性
- **测试目标**: 验证用户数据在各API间的一致性
- **测试步骤**:
  1. 登录用户
  2. 在不同API中验证用户信息
- **预期结果**: 用户信息保持一致

#### 5.2 试戴数据关联
- **测试目标**: 验证试戴数据与用户的正确关联
- **测试步骤**:
  1. 创建试戴记录
  2. 查询历史记录
  3. 验证数据关联
- **预期结果**: 数据正确关联到用户

## 📊 测试执行

### 自动化测试
```bash
# 运行所有集成测试
npm run test:integration:new

# 运行特定API测试
npm run test:api

# 运行完整测试套件
npm run test:all
```

### 手动测试
1. 启动测试服务器: `npm run test:start`
2. 使用浏览器访问各个功能
3. 使用API测试工具验证端点

## 📋 测试检查清单

### 认证系统 ✅
- [ ] CSRF令牌获取正常
- [ ] Mock登录流程正常
- [ ] 会话验证正常
- [ ] 认证状态持久化

### 文件上传 ✅
- [ ] 认证要求正确
- [ ] 支持的文件格式正常
- [ ] 文件大小限制正确
- [ ] Mock存储服务正常

### AI试戴功能 ✅
- [ ] 认证要求正确
- [ ] 试戴流程正常
- [ ] 历史记录查询正常
- [ ] Mock AI服务正常

### 支付功能 ✅
- [ ] 认证要求正确
- [ ] 支付会话创建正常
- [ ] Mock支付服务正常

### 系统集成 ✅
- [ ] 所有API响应正常
- [ ] 错误处理正确
- [ ] 数据一致性保持
- [ ] 性能表现良好

## 🐛 问题记录

### 已解决问题
1. **NextAuth配置问题**: Mock模式下需要使用JWT策略
2. **数据库连接错误**: 在测试模式下使用Mock数据库
3. **外部服务依赖**: 实现完整的Mock服务系统

### 待解决问题
- 无

## 📈 测试指标

### 覆盖率目标
- API端点覆盖率: 100%
- 业务流程覆盖率: 95%
- 错误场景覆盖率: 90%

### 性能指标
- API响应时间: < 2秒
- 文件上传时间: < 10秒
- 试戴处理时间: < 30秒

### 可靠性指标
- 测试通过率: > 95%
- 错误处理覆盖率: 100%
- 安全测试通过率: 100%

## 📝 测试报告

测试执行完成后，详细报告将保存在：
- `tests/reports/integration/`
- `tests/reports/test-results.json`

## 🔄 持续改进

1. **定期更新测试用例**: 随着功能更新同步测试
2. **性能监控**: 持续监控测试执行时间
3. **覆盖率提升**: 定期检查和提升测试覆盖率
4. **自动化增强**: 逐步增加自动化测试比例
